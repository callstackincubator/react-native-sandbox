@startuml

skinparam DefaultFontSize 21

participant HostReactInstance
participant SandboxReactNativeView

participant "//SandboxReactNativeDelegate//" as Delegate

participant SandboxReactInstance

note over Delegate
  Creates isolated React instance,
  injects global ""postMessage"" and
  ""setOnMessage"" functions into
  sandbox JavaScript runtime
end note

group Initialize Sandbox

HostReactInstance -> SandboxReactNativeView : <SandboxReactNativeView>\n  onMessage={handleMessage}\n  onError={handleError}\n/>
SandboxReactNativeView -> Delegate : create isolated React instance
Delegate -> SandboxReactInstance : setup runtime & inject globals
note right of SandboxReactInstance
  ""global.postMessage"" - send to host
  ""global.setOnMessage"" - listen from host
end note

end

...

group Host -> Sandbox

HostReactInstance -> SandboxReactNativeView : Commands.postMessage(\n  JSON.stringify({\n    action: "SETUP",\n    data: { language: 'PL', units: 'm' ...}\n  })\n)
SandboxReactNativeView -> Delegate : postMessage(message)
Delegate -> SandboxReactInstance: call onMessage handler\n(via ""jsi::Runtime"")

end

...

group Sandbox -> Host

SandboxReactInstance -> Delegate : global.postMessage(\n  {action: "ADD_MENU_ITEM"}\n)
Delegate -> SandboxReactNativeView: emit onMessage event\n(via Fabric Event Emitter)
SandboxReactNativeView -> HostReactInstance: onMessage callback\nwith event data

end

...

group Error Handling

SandboxReactInstance -> Delegate : JavaScript error occurs
Delegate -> SandboxReactNativeView: emit onError event\n(via Fabric Event Emitter)
SandboxReactNativeView -> HostReactInstance: onError callback\nwith error details

end

@enduml
